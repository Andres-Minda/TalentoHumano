/*
 * Sistema de Talento Humano - JavaScript Principal
 * Basado en el sistema ITSI
 */

(function($) {
    'use strict';

    // ==============================================================
    // Inicialización de la aplicación
    // ==============================================================
    $(document).ready(function() {
        initializeApp();
        setupEventListeners();
        setupGlobalFunctions();
    });

    // ==============================================================
    // Función de inicialización principal
    // ==============================================================
    function initializeApp() {
        // Configurar tooltips de Bootstrap
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Configurar popovers de Bootstrap
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });

        // Configurar modales de Bootstrap
        var modalTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="modal"]'));
        var modalList = modalTriggerList.map(function (modalTriggerEl) {
            return new bootstrap.Modal(modalTriggerEl);
        });

        // Inicializar componentes personalizados
        initializeCustomComponents();
        
        // Configurar notificaciones
        setupNotifications();
        
        // Configurar validaciones de formularios
        setupFormValidations();
    }

    // ==============================================================
    // Configuración de event listeners
    // ==============================================================
    function setupEventListeners() {
        // Toggle del sidebar en móvil
        $(document).on('click', '#headerCollapse, #sidebarCollapse', function(e) {
            e.preventDefault();
            $('.left-sidebar').toggleClass('show');
        });

        // Cerrar sidebar al hacer clic fuera en móvil
        $(document).on('click', function(e) {
            if ($(window).width() <= 768) {
                if (!$(e.target).closest('.left-sidebar, #headerCollapse, #sidebarCollapse').length) {
                    $('.left-sidebar').removeClass('show');
                }
            }
        });

        // Manejo de redimensionamiento de ventana
        $(window).on('resize', debounce(function() {
            handleWindowResize();
        }, 250));

        // Configurar envío de formularios
        $(document).on('submit', 'form[data-ajax="true"]', handleAjaxFormSubmit);
        
        // Configurar botones de eliminación
        $(document).on('click', '[data-delete]', handleDeleteAction);
        
        // Configurar botones de confirmación
        $(document).on('click', '[data-confirm]', handleConfirmAction);
    }

    // ==============================================================
    // Configuración de funciones globales
    // ==============================================================
    function setupGlobalFunctions() {
        // Hacer disponibles las funciones globalmente
        window.TalentoHumano = {
            showNotification: showNotification,
            showConfirmDialog: showConfirmDialog,
            showLoading: showLoading,
            hideLoading: hideLoading,
            formatDate: formatDate,
            formatCurrency: formatCurrency,
            validateForm: validateForm,
            submitForm: submitForm,
            deleteItem: deleteItem,
            refreshTable: refreshTable
        };
    }

    // ==============================================================
    // Inicialización de componentes personalizados
    // ==============================================================
    function initializeCustomComponents() {
        // Inicializar DataTables si están disponibles
        if (typeof $.fn.DataTable !== 'undefined') {
            $('.datatable').each(function() {
                var $table = $(this);
                var options = $table.data('options') || {};
                
                $table.DataTable({
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
                    },
                    pageLength: 10,
                    responsive: true,
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                         '<"row"<"col-sm-12"tr>>' +
                         '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    ...options
                });
            });
        }

        // Inicializar Select2 si está disponible
        if (typeof $.fn.select2 !== 'undefined') {
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });
        }

        // Inicializar Flatpickr si está disponible
        if (typeof flatpickr !== 'undefined') {
            $('.datepicker').each(function() {
                flatpickr(this, {
                    dateFormat: 'Y-m-d',
                    locale: 'es',
                    allowInput: true
                });
            });
        }
    }

    // ==============================================================
    // Configuración de notificaciones
    // ==============================================================
    function setupNotifications() {
        // Configurar SweetAlert2
        if (typeof Swal !== 'undefined') {
            // Configuración global de SweetAlert2
            Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }
    }

    // ==============================================================
    // Configuración de validaciones de formularios
    // ==============================================================
    function setupFormValidations() {
        // Validación de campos requeridos
        $(document).on('blur', 'input[required], select[required], textarea[required]', function() {
            validateField($(this));
        });

        // Validación de email
        $(document).on('blur', 'input[type="email"]', function() {
            validateEmail($(this));
        });

        // Validación de números
        $(document).on('blur', 'input[type="number"]', function() {
            validateNumber($(this));
        });
    }

    // ==============================================================
    // Funciones de utilidad
    // ==============================================================
    
    // Función debounce para optimizar eventos
    function debounce(func, wait, immediate) {
        var timeout;
        return function executedFunction() {
            var context = this, args = arguments;
            var later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    }

    // Función para mostrar notificaciones
    function showNotification(message, type = 'success', title = '') {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: type,
                title: title,
                text: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        } else {
            // Fallback para cuando SweetAlert2 no está disponible
            var alertClass = 'alert-' + type;
            var alertHtml = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                           message +
                           '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                           '</div>';
            
            // Insertar al inicio del contenido principal
            $('.container-fluid').prepend(alertHtml);
            
            // Auto-ocultar después de 5 segundos
            setTimeout(function() {
                $('.alert').fadeOut();
            }, 5000);
        }
    }

    // Función para mostrar diálogo de confirmación
    function showConfirmDialog(message, title = 'Confirmar', callback) {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: title,
                text: message,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#00367c',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed && typeof callback === 'function') {
                    callback();
                }
            });
        } else {
            // Fallback para cuando SweetAlert2 no está disponible
            if (confirm(message)) {
                if (typeof callback === 'function') {
                    callback();
                }
            }
        }
    }

    // Función para mostrar loading
    function showLoading(message = 'Cargando...') {
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                title: message,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        } else {
            // Fallback para cuando SweetAlert2 no está disponible
            var loadingHtml = '<div class="loading-overlay">' +
                             '<div class="loading-spinner">' +
                             '<div class="spinner-border text-primary" role="status">' +
                             '<span class="visually-hidden">Cargando...</span>' +
                             '</div>' +
                             '<p class="mt-2">' + message + '</p>' +
                             '</div>' +
                             '</div>';
            
            $('body').append(loadingHtml);
        }
    }

    // Función para ocultar loading
    function hideLoading() {
        if (typeof Swal !== 'undefined') {
            Swal.close();
        } else {
            // Fallback para cuando SweetAlert2 no está disponible
            $('.loading-overlay').remove();
        }
    }

    // Función para formatear fechas
    function formatDate(date, format = 'DD/MM/YYYY') {
        if (!date) return '';
        
        var d = new Date(date);
        if (isNaN(d.getTime())) return '';
        
        var day = d.getDate().toString().padStart(2, '0');
        var month = (d.getMonth() + 1).toString().padStart(2, '0');
        var year = d.getFullYear();
        
        return format.replace('DD', day).replace('MM', month).replace('YYYY', year);
    }

    // Función para formatear moneda
    function formatCurrency(amount, currency = 'USD') {
        if (isNaN(amount)) return '';
        
        return new Intl.NumberFormat('es-EC', {
            style: 'currency',
            currency: currency
        }).format(amount);
    }

    // ==============================================================
    // Manejadores de eventos
    // ==============================================================
    
    // Manejador de envío de formularios AJAX
    function handleAjaxFormSubmit(e) {
        e.preventDefault();
        
        var $form = $(this);
        var $submitBtn = $form.find('[type="submit"]');
        var originalText = $submitBtn.text();
        
        // Deshabilitar botón y mostrar loading
        $submitBtn.prop('disabled', true).text('Enviando...');
        
        // Obtener datos del formulario
        var formData = new FormData($form[0]);
        
        // Enviar formulario
        $.ajax({
            url: $form.attr('action'),
            type: $form.attr('method') || 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showNotification(response.message || 'Operación exitosa', 'success');
                    
                    // Recargar página o tabla si es necesario
                    if (response.reload) {
                        location.reload();
                    } else if (response.redirect) {
                        window.location.href = response.redirect;
                    }
                } else {
                    showNotification(response.message || 'Error en la operación', 'error');
                }
            },
            error: function(xhr, status, error) {
                showNotification('Error en la comunicación con el servidor', 'error');
                console.error('Error AJAX:', error);
            },
            complete: function() {
                // Restaurar botón
                $submitBtn.prop('disabled', false).text(originalText);
            }
        });
    }

    // Manejador de acciones de eliminación
    function handleDeleteAction(e) {
        e.preventDefault();
        
        var $btn = $(this);
        var message = $btn.data('message') || '¿Está seguro de que desea eliminar este elemento?';
        var url = $btn.data('url') || $btn.attr('href');
        
        showConfirmDialog(message, 'Confirmar eliminación', function() {
            $.ajax({
                url: url,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        showNotification(response.message || 'Elemento eliminado exitosamente', 'success');
                        
                        // Recargar tabla o página
                        if (response.reload) {
                            location.reload();
                        } else if (response.table) {
                            refreshTable(response.table);
                        }
                    } else {
                        showNotification(response.message || 'Error al eliminar', 'error');
                    }
                },
                error: function() {
                    showNotification('Error en la comunicación con el servidor', 'error');
                }
            });
        });
    }

    // Manejador de acciones de confirmación
    function handleConfirmAction(e) {
        e.preventDefault();
        
        var $btn = $(this);
        var message = $btn.data('message') || '¿Está seguro de que desea realizar esta acción?';
        var callback = $btn.data('callback');
        
        showConfirmDialog(message, 'Confirmar acción', function() {
            if (typeof callback === 'function') {
                callback();
            }
        });
    }

    // ==============================================================
    // Funciones de validación
    // ==============================================================
    
    // Validar campo individual
    function validateField($field) {
        var value = $field.val().trim();
        var isRequired = $field.prop('required');
        var isValid = true;
        var errorMessage = '';
        
        // Validar campo requerido
        if (isRequired && !value) {
            isValid = false;
            errorMessage = 'Este campo es obligatorio';
        }
        
        // Mostrar/ocultar error
        if (!isValid) {
            showFieldError($field, errorMessage);
        } else {
            hideFieldError($field);
        }
        
        return isValid;
    }

    // Validar email
    function validateEmail($field) {
        var email = $field.val().trim();
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email && !emailRegex.test(email)) {
            showFieldError($field, 'Por favor ingrese un email válido');
            return false;
        } else {
            hideFieldError($field);
            return true;
        }
    }

    // Validar número
    function validateNumber($field) {
        var value = $field.val().trim();
        var min = $field.attr('min');
        var max = $field.attr('max');
        
        if (value && isNaN(value)) {
            showFieldError($field, 'Por favor ingrese un número válido');
            return false;
        }
        
        if (min && parseFloat(value) < parseFloat(min)) {
            showFieldError($field, 'El valor mínimo es ' + min);
            return false;
        }
        
        if (max && parseFloat(value) > parseFloat(max)) {
            showFieldError($field, 'El valor máximo es ' + max);
            return false;
        }
        
        hideFieldError($field);
        return true;
    }

    // Mostrar error de campo
    function showFieldError($field, message) {
        hideFieldError($field);
        
        $field.addClass('is-invalid');
        
        var $errorDiv = $('<div class="invalid-feedback">' + message + '</div>');
        $field.after($errorDiv);
    }

    // Ocultar error de campo
    function hideFieldError($field) {
        $field.removeClass('is-invalid');
        $field.siblings('.invalid-feedback').remove();
    }

    // ==============================================================
    // Funciones de utilidad adicionales
    // ==============================================================
    
    // Función para validar formulario completo
    function validateForm($form) {
        var isValid = true;
        
        $form.find('input[required], select[required], textarea[required]').each(function() {
            if (!validateField($(this))) {
                isValid = false;
            }
        });
        
        return isValid;
    }

    // Función para enviar formulario
    function submitForm($form) {
        if (validateForm($form)) {
            $form.submit();
        }
    }

    // Función para eliminar elemento
    function deleteItem(url, message, callback) {
        showConfirmDialog(message || '¿Está seguro de que desea eliminar este elemento?', 'Confirmar eliminación', function() {
            $.ajax({
                url: url,
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        showNotification(response.message || 'Elemento eliminado exitosamente', 'success');
                        if (typeof callback === 'function') {
                            callback(response);
                        }
                    } else {
                        showNotification(response.message || 'Error al eliminar', 'error');
                    }
                },
                error: function() {
                    showNotification('Error en la comunicación con el servidor', 'error');
                }
            });
        });
    }

    // Función para refrescar tabla
    function refreshTable(tableSelector) {
        var $table = $(tableSelector);
        if ($table.length && $table.DataTable) {
            $table.DataTable().ajax.reload();
        } else {
            location.reload();
        }
    }

    // ==============================================================
    // Manejador de redimensionamiento de ventana
    // ==============================================================
    function handleWindowResize() {
        var width = $(window).width();
        
        if (width <= 768) {
            // Móvil: ocultar sidebar
            $('.left-sidebar').removeClass('show');
        } else {
            // Desktop: mostrar sidebar
            $('.left-sidebar').removeClass('show');
        }
    }

    // ==============================================================
    // Configuración de estilos CSS dinámicos
    // ==============================================================
    function addDynamicStyles() {
        var styles = `
            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            }
            
            .loading-spinner {
                text-align: center;
                color: white;
            }
            
            .fade-in {
                animation: fadeIn 0.5s ease-in;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        
        var $style = $('<style>').text(styles);
        $('head').append($style);
    }

    // Agregar estilos dinámicos al cargar
    $(document).ready(function() {
        addDynamicStyles();
    });

})(jQuery);